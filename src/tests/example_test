import sys
import os
# Add the parent directory to the system path
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import radio_utils

# Constants
SEND_PORT = 'COM5' # '/dev/ttyUSB0'  # Serial port for sending radio
RECEIVE_PORT = 'COM6' # '/dev/ttyUSB1'  # Serial port for receiving radio
BAUDRATE = 57600  # Baud rate for SiK radios
MESSAGE = 'Pan Szczekoscisk!'  # Message to send
INTERVAL = 2  # Interval between sends in seconds

def send_message(serial_port, message):
    """Send a message through the serial port."""
    serial_port.write((message + '\r\n').encode())

def main():
    # Open serial connections
    send_radio = radio_utils.RadioModule(SEND_PORT, BAUDRATE)
    receive_radio = radio_utils.RadioModule(RECEIVE_PORT, BAUDRATE)

    try:
        while True:
            # Send message
            send_message(send_radio, MESSAGE)
            print(f"Sent: {MESSAGE}")
            
            # Get telemetry data from receiving radio
            tdm_report, rssi_report = receive_radio.get_output_data()
            if tdm_report and rssi_report is not None:
                print(f"{tdm_report}\n{rssi_report}")
            else:
                print("Failed to extract reports.")
            
            # Wait before sending the next message
            radio_utils.time.sleep(INTERVAL)
    except KeyboardInterrupt:
        print("Stopping transmission.")

if __name__ == "__main__":
    main()